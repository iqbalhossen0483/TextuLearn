# Active Context: AI Book Agent Platform

## Current Work Focus

**Backend:**

- **Production-Level Authentication**: User data returned from `/register` and `/login` routes is now curated to exclude sensitive information like hashed passwords.
- Ensuring MongoDB connection and service layer are robust.
- Verifying API route functionality and Celery worker operations.

## Recent Changes

**Backend:**

- **Chatbot Agent Logic Implementation (`server/agents/runners/chatbot_agent.py`)**:
  - The `chatbot_agent_response` function now fully implements the chat logic:
    - Utilizes Google ADK's `Runner` and `InMemorySessionService` for agent interaction.
    - Integrates with MongoDB (`sessions` collection via `current_app.mongo_service`):
      - Creates new chat sessions in MongoDB if a `session_id` is not provided or an existing session isn't found.
      - Stores user messages and subsequent agent responses in the corresponding session document.
    - Handles optional file uploads by including them as `inline_data` parts in the ADK `Content` object.
    - Streams responses back to the client, prefixing data chunks:
      - `json: {"session_id": "..."}`: Sent when a new session is created.
      - `data: ...`: For actual message content from the agent.
      - `error: ...`: For any errors encountered during processing.
    - Employs `asyncio` and `threading.Thread` to run the ADK agent asynchronously and stream results via a `queue.Queue`.
- **Chatbot Agent Route Implementation (`server/routes/agents.py`)**:
  - The `/chatbot` endpoint in `server/routes/agents.py` correctly invokes `chatbot_agent_response`.
  - It handles POST requests with `question`, `user_id`, `session_id` (optional), and `files` (optional).
  - It uses `stream_with_context` to stream responses generated by `chatbot_agent_response`.
- **Auth Route Update (User Data Response)**:
  - Modified `server/routes/auth_routes.py`:
    - `/register` and `/login` routes now return a curated `user` object (id, email, created_at) instead of the raw MongoDB document, enhancing security.
- **Auth Route Update (Register - JWT)**:
  - Modified `server/routes/auth_routes.py`:
    - `/register` route now generates and returns a JWT token, user's email, and user_id upon successful registration.
- **Auth Route Refinement (Register & Login - Previous)**:
  - Modified `server/routes/auth_routes.py`:
    - `/register` route:
      - Removed `username` from input.
      - Added `confirm_password` field and validation.
      - `username` is no longer stored in the user document on registration.
    - `/login` route:
      - JWT payload now includes `email` instead of `username`.
      - Login response now includes `email`.
- **Authentication Overhaul (Production Ready - Initial)**:
  - Added `PyJWT` to `server/requirements.txt`.
  - Added `SECRET_KEY` to `server/config/settings.py` (to be set in `.env`).
  - Modified `server/routes/auth_routes.py`:
    - Implemented password hashing with `werkzeug.security`.
    - Implemented JWT generation and token-based login.
    - Added `created_at` field for user registration.
- **MongoDB Integration**:
  - Added `pymongo` to `server/requirements.txt`.
  - Added `MONGO_URL` to `server/config/settings.py`.
  - Created `server/services/mongo_service.py`.
  - Initialized `MongoService` in `server/app.py`.

**Frontend:**

- **Chatbot Message Rendering (Markdown with Custom Styling)**:
  - Installed `react-markdown` and `remark-gfm` in the `frontend` project.
  - Modified `frontend/src/components/chatbot/MessageItem.jsx` to use `ReactMarkdown` with `remarkGfm` plugin.
  - Added custom renderers via the `components` prop in `ReactMarkdown` to apply specific Tailwind CSS styles to various HTML tags (e.g., `h1`, `p`, `a`, `table`, `code`, `blockquote`), providing fine-grained control over the appearance of Markdown content.
- **Chatbot API Integration (using Fetch for streaming)**:
  - Updated `frontend/src/services/chatService.js`: The `sendChatMessageStream` function now uses `fetch` to call the `/api/agent/chatbot` endpoint and returns a standard `fetch` Response object. This is to leverage native browser streaming capabilities.
  - Modified `frontend/src/components/chatbot/ChatInterface.jsx`:
    - Enhanced to fully integrate with the streaming `/agent/chatbot` backend endpoint.
    - Sends `question`, `user_id`, `session_id` (if available), and a `save` (boolean) flag as `FormData`.
    - Retrieves `user_id` from `useAuth` context and `authToken` from `localStorage` for the API request.
    - Implements robust stream handling using `response.body.getReader()` and `TextDecoder`:
      - Parses incoming chunks prefixed with `json:`, `data:`, or `error:`.
      - Updates `sessionId` state when a `json:` chunk with `session_id` is received.
      - Appends `data:` chunks incrementally to the current bot message in the UI.
      - Displays errors received via `error:` chunks.
    - Manages `isLoading` state to provide user feedback during API calls.
    - Includes a retry mechanism (`handleSendMessage("retry", false)`) when an error occurs.
  - Modified `frontend/src/components/chatbot/MessageInput.jsx`:
    - Accepts and uses `isLoading` prop to disable input and send button during API calls.
- **Mobile Navigation Refinement**:
  - Refactored `frontend/src/components/common/MobileSidePanel.jsx`:
    - Links are now generated by mapping over `navLinks` and `authLinks` arrays.
    - Standard navigation links use the Next.js `Link` component directly (no nested `<a>` tags).
    - Authentication links (Login/Register) now use the custom `Button` component from `../libs/Button.jsx`, matching variants used in `NavBar.jsx`.
    - Changed close button icon from `XMarkIcon` (Heroicons) to `MdClose` (react-icons/md) to align with project dependencies.
  - (Previous) Created `frontend/src/components/common/MobileSidePanel.jsx`.
  - (Previous) Modified `frontend/src/components/common/NavBar.jsx`:
    - Integrated `MobileSidePanel.jsx`.
    - Added state (`isMobileMenuOpen`) and handlers (`openMobileMenu`, `closeMobileMenu`) to toggle the side panel.
    - Replaced `MdOutlineMenu` with `Bars3Icon` from Heroicons for the mobile menu trigger.
    - Adjusted `NavBar` z-index to ensure `MobileSidePanel` displays correctly.
- **Books Page Implementation (Previous)**:
  - Created `frontend/src/app/books/page.jsx`.
  - Implemented `frontend/src/components/books/BookSearch.jsx`.
  - Implemented `frontend/src/components/books/BookList.jsx`.
  - Implemented `frontend/src/components/books/BookCard.jsx`.
- **Responsiveness**: Home page and Chatbot page components are fully responsive.
- **Chatbot UI Updates**: Message input and session history panel designs updated.
- **Layout Refactor**: `PageShell.jsx` handles conditional rendering of `NavBar` and `Footer`.
- **Componentization**: `ChatInterface.jsx` broken into smaller components.
- **Pages Created**: Chatbot, Register, Login pages.
- **Core Components**: Footer, CallToActionBanner, Faq, WhyChoose, KeyFeatures, Banner, Button, NavBar.
- **Project Setup**: Next.js, Tailwind CSS, global color palette.

## Next Steps

**Backend:**

- **Username Handling (Optional)**: Decide if `username` should be an optional field that users can set/update post-registration. If so, implement an endpoint for this.
- **Protected Routes**: Implement a decorator or middleware to protect routes that require authentication using the JWT.
- **User Profile Management**: Consider API endpoints for users to view/update their profiles.
- **Celery Worker Verification**: Continue to monitor and ensure Celery workers process tasks correctly.
- **Testing**: Thoroughly test all API endpoints, especially authentication and data processing.

**Frontend:**

- **Update Auth Forms & Logic**: Adapt registration and login logic to handle the curated `user` object and the token returned.
- **Integrate Auth**: Connect login/register forms to the updated backend auth endpoints.
- **Token Management**: Store and use JWT on the frontend for authenticated requests.
- **Protected Routes (Frontend)**: Implement route guards based on authentication status.
- Continue UI development for core features.

## Active Decisions and Considerations

- **Username Strategy**: How will usernames be handled if they are needed later (e.g., for display purposes, unique identifiers beyond email)?
- **JWT Expiration and Refresh Tokens**: Current JWT expires in 24 hours. For a more robust system, consider implementing refresh tokens.
- **Error Handling**: Continue refining error handling across all services and routes.
- **Input Validation**: Ensure comprehensive input validation for all API endpoints.
- **Security**: Regularly review security practices, especially around authentication and data handling.
